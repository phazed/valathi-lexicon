<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vrahune Generator Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #050505;
      --bg-alt: #101010;
      --accent: #c0c0c0;          /* silver */
      --accent-soft: rgba(192,192,192,0.22);
      --text: #f5f5f5;
      --muted: #a0a0a0;
      --border: #2a2a2a;
      --danger: #ff8080;
      --shadow-soft: 0 14px 40px rgba(0, 0, 0, 0.75);
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #222 0, #050505 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app-shell {
      max-width: 1200px;
      width: 100%;
      padding: 24px;
    }

    .card {
      background: linear-gradient(145deg, rgba(8, 8, 8, 0.97), rgba(4, 4, 4, 0.99));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 20px 20px 18px;
      backdrop-filter: blur(10px);
    }

    h1, h2, h3 {
      margin: 0 0 8px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    h1 {
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(192,192,192,0.55);
      background: radial-gradient(circle at top, rgba(230,230,230,0.25), transparent 60%);
      font-size: 0.9rem;
      color: var(--text);
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 16px;
    }

    label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(12, 12, 12, 0.95);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: rgba(18, 18, 18, 1);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    button {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 7px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, border-color 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #f5f5f5, #bfbfbf);
      color: #111;
      box-shadow: 0 8px 22px rgba(200, 200, 200, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(230, 230, 230, 0.6);
    }

    .btn-secondary {
      background: transparent;
      border-color: var(--border);
      color: var(--muted);
    }

    .btn-secondary:hover {
      border-color: var(--accent-soft);
      background: rgba(18, 18, 18, 0.96);
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 0.8rem;
    }

    .btn-icon {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 1rem;
      border-color: var(--border);
    }

    .btn-icon:hover {
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.04);
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .col {
      flex: 1;
      min-width: 140px;
    }

    .section-title {
      font-size: 0.95rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .section-title span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .muted {
      color: var(--muted);
      font-size: 0.8rem;
    }

    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0;
    }

    .danger {
      color: var(--danger);
    }

    /* Layout: left nav, right panel */
    .hub-body {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }

    .nav-column {
      width: 280px;
      min-width: 240px;
      max-width: 320px;
      display: flex;
      flex-direction: column;
    }

    .detail-column {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 900px) {
      .hub-body {
        flex-direction: column;
      }
      .nav-column {
        width: 100%;
        max-width: 100%;
      }
    }

    /* NAV AREA (folders + generators) */
    .nav-area {
      border-radius: 12px;
      border: 1px solid rgba(60,60,60,0.9);
      background: linear-gradient(180deg, rgba(10,10,10,0.98), rgba(5,5,5,0.98));
      padding: 6px 8px;
      max-height: 360px;
      overflow-y: auto;
      margin-top: 8px;
      margin-bottom: 12px;
    }

    .nav-folder-heading {
      font-size: 0.78rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.11em;
      margin: 6px 4px 2px;
    }

    .nav-generator {
      font-size: 0.86rem;
      padding: 5px 8px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 6px;
      margin: 2px 2px;
      border: 1px solid transparent;
    }

    .nav-generator span.name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav-generator:hover {
      border-color: var(--border);
      background: rgba(255,255,255,0.03);
    }

    .nav-generator.active {
      border-color: var(--accent);
      background: rgba(255,255,255,0.06);
    }

    .folder-badge {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    /* Create / edit box */
    .create-box {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed rgba(120,120,120,0.7);
      background: rgba(10,10,10,0.95);
    }

    /* Active generator panel */
    .generator-panel {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(70,70,70,0.9);
      background: radial-gradient(circle at top left, rgba(255,255,255,0.05), rgba(8,8,8,0.96));
      min-height: 80px;
      margin-top: 8px;
    }

    .generator-title-main {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .generated-list {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(45,45,45,0.9);
      background: rgba(8,8,8,0.98);
      max-height: 220px;
      overflow-y: auto;
      font-size: 0.88rem;
    }

    .generated-item {
      padding: 3px 0;
      cursor: pointer;
    }

    .generated-item:hover {
      text-decoration: underline;
    }

    .copy-message {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .items-expanded {
      min-height: 260px !important;
      max-height: 70vh;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="card">
      <h1>
        <span class="logo">V</span>
        Vrahune Generator Hub
      </h1>
      <div class="subtitle">
        Left: folders & generators (including your lexicons). Right: controls & results for the selected generator.
      </div>

      <div class="hub-body">
        <!-- LEFT: NAV / FOLDERS -->
        <div class="nav-column">
          <div class="section-title">
            <span>Generators</span>
            <button id="addGeneratorBtn" class="btn-secondary btn-icon" title="Create new generator">
              ＋
            </button>
          </div>

          <div id="generatorCreateBox" class="create-box" style="display:none;">
            <div class="muted" style="margin-bottom:6px;">
              Create or edit a generator. Items can be names, lexicon entries, book titles, etc.
              One per line or comma-separated. Duplicates are removed automatically.
            </div>

            <div class="row">
              <div class="col">
                <label for="genFolderInput">Folder name</label>
                <input id="genFolderInput" type="text" placeholder="e.g. Lexicons, Names, Taverns" value="General">
              </div>
              <div class="col">
                <label for="genNameInput">Generator name</label>
                <input id="genNameInput" type="text" placeholder="e.g. Valathi Lexicon, Tavern Names">
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label for="genItemsInput">Items list</label>
                <textarea id="genItemsInput" placeholder="One item per line, or comma-separated..."></textarea>
                <button type="button" id="expandItemsBtn" class="btn-secondary btn-small" style="margin-top:4px;">
                  Expand list editor
                </button>
              </div>
            </div>

            <div class="row">
              <button id="saveGeneratorBtn" class="btn-primary">
                Save generator
              </button>
              <button id="cancelGeneratorBtn" class="btn-secondary">
                Cancel
              </button>
            </div>

            <div id="generatorCreateMessage" class="muted"></div>
          </div>

          <div id="generatorNav" class="nav-area"></div>
        </div>

        <!-- RIGHT: ACTIVE GENERATOR PANEL -->
        <div class="detail-column">
          <div class="section-title">
            <span id="activeGeneratorLabel">No generator selected</span>
          </div>

          <div id="generatorPanel" class="generator-panel">
            <div class="muted">
              Choose a generator from the left, or click ＋ to create one. This panel will show its controls and results.
            </div>
          </div>

          <div id="copyMessage" class="copy-message">
            Click any generated item to copy it.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --------------------------------
    // STORAGE & STATE
    // --------------------------------
    const GEN_STORAGE_KEY = "vrahuneGeneratorsV2"; // new key so this version is clean

    // generator object: { id, folder, name, type, items[] }
    // type: "elf", "book", "list" (default list)

    let activeGenerator = null;
    let editingGeneratorId = null;
    let itemsExpanded = false;

    // --------------------------------
    // HELPERS
    // --------------------------------
    function rand(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function showCopyMessage(text) {
      const msg = document.getElementById("copyMessage");
      msg.textContent = `Copied: "${text}"`;
      setTimeout(() => {
        msg.textContent = "Click any generated item to copy it.";
      }, 2500);
    }

    function handleCopyClick(event) {
      const target = event.target;
      if (!target.classList.contains("generated-item")) return;
      const text = target.textContent.trim();
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => showCopyMessage(text))
          .catch(() => showCopyMessage(text));
      } else {
        showCopyMessage(text);
      }
    }

    // --------------------------------
    // BUILT-IN LOGIC (not labeled as built-in in UI)
    // --------------------------------
    // Elf name parts
    const elfStartsClassic = [
      "Val", "Ves", "Vor", "Vrae", "Sel", "Thal", "Mir", "Nor", "Lae", "Vel", "Vyn", "Maer"
    ];

    const elfStartsNewGen = [
      "Ael", "Ny", "Syl", "Cae", "Ari", "Eli", "Var", "Lor", "Sael", "Cal", "Ser", "Ty", "Vael", "Oryn"
    ];

    const elfMiddles = [
      "a", "e", "i", "o", "la", "le", "li", "ra", "re", "ri", "sa", "se", "thal", "lyn", "rin"
    ];

    const elfEndNeutral = [
      "en", "el", "eth", "ir", "is", "as", "or", "ar", "ion", "iel", "ira", "yn"
    ];

    const elfEndSoft = [
      "a", "ae", "ira", "iel", "essa", "yn", "yne", "ara", "ina"
    ];

    const elfEndSharp = [
      "as", "ix", "or", "eth", "is", "ar", "ax", "an", "orix"
    ];

    function generateSingleElfName(style, tone) {
      const startPool = style === "valathi-classic" ? elfStartsClassic : elfStartsNewGen;
      let endPool = elfEndNeutral;

      if (tone === "soft") {
        endPool = elfEndSoft;
      } else if (tone === "sharp") {
        endPool = elfEndSharp;
      }

      const start = rand(startPool);
      const useMiddle = Math.random() < 0.55;
      let middle = "";
      if (useMiddle) {
        middle = rand(elfMiddles);
      }
      const end = rand(endPool);

      const raw = start + middle + end;
      return raw.charAt(0).toUpperCase() + raw.slice(1);
    }

    // Book title parts
    const bookAdjCommon = [
      "Silent", "Forgotten", "Gilded", "Broken", "Crimson", "Twilight", "Shattered",
      "Hidden", "Last", "Bound", "Whispering", "Silver", "Onyx", "Verdant", "Burning", "Veiled"
    ];

    const bookNounCommon = [
      "Throne", "Forest", "Empire", "Oath", "Crown", "River", "Sea", "Spire",
      "Song", "Shadow", "Light", "Wolf", "King", "Queen", "Chronicle", "Blade", "Storm", "Gate"
    ];

    const bookOfPhrases = [
      "of Vrahune",
      "of the Valathar",
      "of the North",
      "of the Verdant Veil",
      "of the Onyx Empire",
      "of the Fallen Spears",
      "of the Dawn War",
      "of the Silver Mountain"
    ];

    const bookValathiBits = [
      "Val’athanna", "Valdora", "Vrahune", "Saelvorion",
      "Lir’ath", "Vraedor", "Mirlen", "Nor’thal", "Vesnar"
    ];

    function generateSingleBookTitle(flavor) {
      const pattern = Math.floor(Math.random() * 3);

      const adj = rand(bookAdjCommon);
      const noun1 = rand(bookNounCommon);
      const noun2 = rand(bookNounCommon.filter(n => n !== noun1));
      const ofPhrase = rand(bookOfPhrases);

      if (flavor === "common") {
        if (pattern === 0) {
          return `The ${adj} ${noun1}`;
        } else if (pattern === 1) {
          return `${noun1} of ${noun2}`;
        } else {
          return `The ${noun1} ${ofPhrase}`;
        }
      } else {
        const valBit = rand(bookValathiBits);
        if (pattern === 0) {
          return `The ${adj} ${noun1} of ${valBit}`;
        } else if (pattern === 1) {
          return `${noun1} of ${valBit}`;
        } else {
          return `${valBit}: The ${adj} ${noun1}`;
        }
      }
    }

    // --------------------------------
    // GENERATOR STORAGE
    // --------------------------------
    function seedInitialGenerators() {
      // Only called if storage empty
      return [
        {
          id: "gen-elf",
          folder: "Names",
          name: "Elf Names (Valathar)",
          type: "elf",
          items: []
        },
        {
          id: "gen-book",
          folder: "Names",
          name: "Book Titles",
          type: "book",
          items: []
        },
        {
          id: "gen-lex-valathi",
          folder: "Lexicons",
          name: "Valathi Lexicon",
          type: "list",
          items: [
            "val", "’ath", "anna", "dor", "vor", "mir", "len", "vrae",
            "sel", "thal", "nor", "sael", "cyn", "Vrahune",
            "Val’athanna", "Valdora"
          ]
        }
      ];
    }

    function loadGenerators() {
      try {
        const raw = window.localStorage.getItem(GEN_STORAGE_KEY);
        if (!raw) {
          const seeded = seedInitialGenerators();
          saveGenerators(seeded);
          return seeded;
        }
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length === 0) {
          const seeded = seedInitialGenerators();
          saveGenerators(seeded);
          return seeded;
        }
        // Ensure type defaults to "list" if missing (old data)
        return parsed.map(g => ({
          ...g,
          type: g.type || "list",
          items: Array.isArray(g.items) ? g.items : []
        }));
      } catch {
        const seeded = seedInitialGenerators();
        saveGenerators(seeded);
        return seeded;
      }
    }

    function saveGenerators(list) {
      try {
        window.localStorage.setItem(GEN_STORAGE_KEY, JSON.stringify(list));
      } catch {}
    }

    function parseGeneratorItems(rawText) {
      if (!rawText) return { items: [], duplicates: 0 };
      const normalized = rawText.replace(/,/g, "\n");
      const lines = normalized.split(/\r?\n/);
      const set = new Set();
      const items = [];
      let total = 0;

      for (const line of lines) {
        const t = line.trim();
        if (!t) continue;
        total++;
        const key = t.toLowerCase();
        if (!set.has(key)) {
          set.add(key);
          items.push(t);
        }
      }
      const duplicates = Math.max(0, total - items.length);
      return { items, duplicates };
    }

    // --------------------------------
    // NAV RENDERING
    // --------------------------------
    function renderGeneratorNav() {
      const nav = document.getElementById("generatorNav");
      nav.innerHTML = "";

      const gens = loadGenerators();
      const folderMap = {};

      gens.forEach(gen => {
        const folder = gen.folder || "General";
        if (!folderMap[folder]) folderMap[folder] = [];
        folderMap[folder].push(gen);
      });

      const folderNames = Object.keys(folderMap).sort((a, b) => a.localeCompare(b));

      if (!folderNames.length) {
        nav.innerHTML = `<div class="muted" style="font-size:0.8rem; padding:4px 4px 8px;">No generators yet. Click ＋ to create one.</div>`;
        return;
      }

      folderNames.forEach(folder => {
        const heading = document.createElement("div");
        heading.className = "nav-folder-heading";
        heading.innerHTML = `${folder} <span class="folder-badge">(${folderMap[folder].length})</span>`;
        nav.appendChild(heading);

        folderMap[folder]
          .sort((a,b) => a.name.localeCompare(b.name))
          .forEach(gen => {
            const item = document.createElement("div");
            item.className = "nav-generator";
            item.dataset.id = gen.id;

            const isActive = activeGenerator && activeGenerator.id === gen.id;
            if (isActive) item.classList.add("active");

            item.innerHTML = `<span class="name">${gen.name}</span>`;
            nav.appendChild(item);
          });
      });
    }

    // --------------------------------
    // ACTIVE GENERATOR PANEL
    // --------------------------------
    function renderActiveGeneratorPanel() {
      const label = document.getElementById("activeGeneratorLabel");
      const panel = document.getElementById("generatorPanel");
      panel.innerHTML = "";
      panel.removeEventListener("click", handleCopyClick); // safety

      if (!activeGenerator) {
        label.textContent = "No generator selected";
        panel.innerHTML = `<div class="muted">Choose a generator from the left, or click ＋ to create one.</div>`;
        return;
      }

      const gens = loadGenerators();
      const gen = gens.find(g => g.id === activeGenerator.id);
      if (!gen) {
        label.textContent = "Generator not found";
        panel.innerHTML = `<div class="muted">This generator no longer exists. Choose another one.</div>`;
        return;
      }

      label.textContent = `${gen.name} (${gen.folder || "General"})`;

      // Pattern-based: elf
      if (gen.type === "elf") {
        panel.innerHTML = `
          <div class="generator-title-main">
            ${gen.name}
          </div>
          <div class="muted" style="margin-bottom:8px;">
            Generates Valathar-style names (classic Valathi or newer, mixed-region vibes).
          </div>
          <div class="row">
            <div class="col">
              <label for="elfStyle">Style</label>
              <select id="elfStyle">
                <option value="valathi-classic">Valathi Classic</option>
                <option value="new-gen">New Gen / Mixed</option>
              </select>
            </div>
            <div class="col">
              <label for="elfTone">Tone</label>
              <select id="elfTone">
                <option value="neutral">Neutral</option>
                <option value="soft">Soft-leaning</option>
                <option value="sharp">Sharp/edgy</option>
              </select>
            </div>
            <div class="col">
              <label for="elfCount">Count</label>
              <input id="elfCount" type="number" min="1" max="30" value="10">
            </div>
          </div>
          <div class="row">
            <button id="elfGenerateBtn" class="btn-primary">Generate</button>
            <button id="elfEditBtn" class="btn-secondary btn-small">Edit generator meta</button>
          </div>
          <div id="elfResults" class="generated-list" style="margin-top:8px;"></div>
        `;

        const btn = panel.querySelector("#elfGenerateBtn");
        const results = panel.querySelector("#elfResults");
        const styleSel = panel.querySelector("#elfStyle");
        const toneSel = panel.querySelector("#elfTone");
        const countInput = panel.querySelector("#elfCount");
        const editBtn = panel.querySelector("#elfEditBtn");

        btn.addEventListener("click", () => {
          const style = styleSel.value;
          const tone = toneSel.value;
          const count = Math.max(1, Math.min(30, parseInt(countInput.value || "1", 10)));
          results.innerHTML = "";
          const frag = document.createDocumentFragment();
          for (let i = 0; i < count; i++) {
            const name = generateSingleElfName(style, tone);
            const div = document.createElement("div");
            div.className = "generated-item";
            div.textContent = name;
            frag.appendChild(div);
          }
          results.appendChild(frag);
        });

        results.addEventListener("click", handleCopyClick);

        editBtn.addEventListener("click", () => {
          openEditGeneratorBox(gen.id);
        });

        return;
      }

      // Pattern-based: book
      if (gen.type === "book") {
        panel.innerHTML = `
          <div class="generator-title-main">
            ${gen.name}
          </div>
          <div class="muted" style="margin-bottom:8px;">
            Titles for tomes, legends, grimoires. Common tongue or Valathi-flavored.
          </div>
          <div class="row">
            <div class="col">
              <label for="bookFlavor">Flavor</label>
              <select id="bookFlavor">
                <option value="common">Common tongue</option>
                <option value="valathi">Valathi-flavored</option>
              </select>
            </div>
            <div class="col">
              <label for="bookCount">Count</label>
              <input id="bookCount" type="number" min="1" max="30" value="10">
            </div>
          </div>
          <div class="row">
            <button id="bookGenerateBtn" class="btn-primary">Generate</button>
            <button id="bookEditBtn" class="btn-secondary btn-small">Edit generator meta</button>
          </div>
          <div id="bookResults" class="generated-list" style="margin-top:8px;"></div>
        `;

        const btn = panel.querySelector("#bookGenerateBtn");
        const results = panel.querySelector("#bookResults");
        const flavorSel = panel.querySelector("#bookFlavor");
        const countInput = panel.querySelector("#bookCount");
        const editBtn = panel.querySelector("#bookEditBtn");

        btn.addEventListener("click", () => {
          const flavor = flavorSel.value;
          const count = Math.max(1, Math.min(30, parseInt(countInput.value || "1", 10)));
          results.innerHTML = "";
          const frag = document.createDocumentFragment();
          for (let i = 0; i < count; i++) {
            const title = generateSingleBookTitle(flavor);
            const div = document.createElement("div");
            div.className = "generated-item";
            div.textContent = title;
            frag.appendChild(div);
          }
          results.appendChild(frag);
        });

        results.addEventListener("click", handleCopyClick);

        editBtn.addEventListener("click", () => {
          openEditGeneratorBox(gen.id);
        });

        return;
      }

      // List-based (including Lexicon folder)
      panel.innerHTML = `
        <div class="generator-title-main">
          ${gen.name}
        </div>
        <div class="muted" style="margin-bottom:8px;">
          Folder: ${gen.folder || "General"} · ${gen.items.length} items in pool.
        </div>
        <div class="row">
          <div class="col">
            <label for="customCountInput">Count</label>
            <input id="customCountInput" type="number" min="1" max="50" value="10">
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <button id="customGenerateBtn" class="btn-primary">Generate</button>
          </div>
        </div>
        <div class="row">
          <button id="customEditBtn" class="btn-secondary btn-small">Edit items</button>
          <button id="customDeleteBtn" class="btn-secondary btn-small">Delete generator</button>
        </div>
        <div id="customResults" class="generated-list"></div>
      `;

      const countInput = panel.querySelector("#customCountInput");
      const genBtn = panel.querySelector("#customGenerateBtn");
      const editBtn = panel.querySelector("#customEditBtn");
      const delBtn  = panel.querySelector("#customDeleteBtn");
      const results = panel.querySelector("#customResults");

      genBtn.addEventListener("click", () => {
        const pool = [...gen.items];
        const count = Math.max(1, Math.min(50, parseInt(countInput.value || "1", 10)));
        results.innerHTML = "";
        const frag = document.createDocumentFragment();
        if (!pool.length) return;
        for (let i = 0; i < count; i++) {
          if (!pool.length) break;
          const idx = Math.floor(Math.random() * pool.length);
          const value = pool.splice(idx, 1)[0];
          const div = document.createElement("div");
          div.className = "generated-item";
          div.textContent = value;
          frag.appendChild(div);
        }
        results.appendChild(frag);
      });

      results.addEventListener("click", handleCopyClick);

      editBtn.addEventListener("click", () => {
        openEditGeneratorBox(gen.id);
      });

      delBtn.addEventListener("click", () => {
        const ok = window.confirm(`Delete generator “${gen.name}” from folder “${gen.folder || "General"}”?`);
        if (!ok) return;
        const newList = gens.filter(g => g.id !== gen.id);
        saveGenerators(newList);
        if (activeGenerator && activeGenerator.id === gen.id) {
          activeGenerator = null;
        }
        renderGeneratorNav();
        renderActiveGeneratorPanel();
      });
    }

    // --------------------------------
    // CREATE / EDIT GENERATOR BOX
    // --------------------------------
    function openNewGeneratorBox() {
      editingGeneratorId = null;
      const box = document.getElementById("generatorCreateBox");
      const msg = document.getElementById("generatorCreateMessage");
      const folderInput = document.getElementById("genFolderInput");
      const nameInput   = document.getElementById("genNameInput");
      const itemsInput  = document.getElementById("genItemsInput");
      const saveBtn     = document.getElementById("saveGeneratorBtn");
      const expandBtn   = document.getElementById("expandItemsBtn");

      folderInput.value = "General";
      nameInput.value = "";
      itemsInput.value = "";
      itemsInput.classList.remove("items-expanded");
      itemsExpanded = false;
      expandBtn.textContent = "Expand list editor";
      msg.textContent = "";
      msg.classList.remove("danger");
      saveBtn.textContent = "Save generator";

      box.style.display = "block";
    }

    function openEditGeneratorBox(genId) {
      const gens = loadGenerators();
      const gen = gens.find(g => g.id === genId);
      if (!gen) return;

      editingGeneratorId = genId;
      const box = document.getElementById("generatorCreateBox");
      const msg = document.getElementById("generatorCreateMessage");
      const folderInput = document.getElementById("genFolderInput");
      const nameInput   = document.getElementById("genNameInput");
      const itemsInput  = document.getElementById("genItemsInput");
      const saveBtn     = document.getElementById("saveGeneratorBtn");
      const expandBtn   = document.getElementById("expandItemsBtn");

      folderInput.value = gen.folder || "General";
      nameInput.value   = gen.name || "";
      itemsInput.value  = Array.isArray(gen.items) ? gen.items.join("\n") : "";
      itemsInput.classList.remove("items-expanded");
      itemsExpanded = false;
      expandBtn.textContent = "Expand list editor";

      msg.textContent = `Editing “${gen.name}”. Items edit only, generator type stays the same.`;
      msg.classList.remove("danger");
      saveBtn.textContent = "Save changes";

      box.style.display = "block";
    }

    function hideGeneratorCreateBox() {
      const box = document.getElementById("generatorCreateBox");
      const msg = document.getElementById("generatorCreateMessage");
      document.getElementById("genNameInput").value = "";
      document.getElementById("genItemsInput").value = "";
      msg.textContent = "";
      msg.classList.remove("danger");
      editingGeneratorId = null;
      const itemsInput  = document.getElementById("genItemsInput");
      const expandBtn   = document.getElementById("expandItemsBtn");
      itemsInput.classList.remove("items-expanded");
      itemsExpanded = false;
      expandBtn.textContent = "Expand list editor";
      box.style.display = "none";
    }

    function handleSaveGenerator() {
      const folderInput = document.getElementById("genFolderInput");
      const nameInput   = document.getElementById("genNameInput");
      const itemsInput  = document.getElementById("genItemsInput");
      const msg         = document.getElementById("generatorCreateMessage");

      const folder = (folderInput.value || "").trim() || "General";
      const name   = (nameInput.value || "").trim();
      const raw    = itemsInput.value || "";

      if (!name) {
        msg.textContent = "Please enter a name for the generator.";
        msg.classList.add("danger");
        return;
      }

      const { items, duplicates } = parseGeneratorItems(raw);
      if (!items.length) {
        msg.textContent = "Please provide at least one non-empty item.";
        msg.classList.add("danger");
        return;
      }

      const gens = loadGenerators();
      if (editingGeneratorId) {
        const idx = gens.findIndex(g => g.id === editingGeneratorId);
        if (idx !== -1) {
          const existingType = gens[idx].type || "list";
          gens[idx].folder = folder;
          gens[idx].name   = name;
          gens[idx].items  = items;
          gens[idx].type   = existingType; // keep elf/book/list as-is
        }
        saveGenerators(gens);
        msg.classList.remove("danger");
        msg.textContent = `Updated “${name}” with ${items.length} items. ${duplicates > 0 ? duplicates + " duplicates removed." : "No duplicates detected."}`;
        activeGenerator = { id: editingGeneratorId };
        editingGeneratorId = null;
      } else {
        const id = "gen-" + Date.now() + "-" + Math.floor(Math.random() * 10000);
        gens.push({ id, folder, name, type: "list", items });
        saveGenerators(gens);
        msg.classList.remove("danger");
        msg.textContent = `Saved “${name}” in folder “${folder}” with ${items.length} items. ${duplicates > 0 ? duplicates + " duplicates removed." : "No duplicates detected."}`;
        activeGenerator = { id };
      }

      renderGeneratorNav();
      renderActiveGeneratorPanel();

      setTimeout(() => {
        hideGeneratorCreateBox();
      }, 1200);
    }

    function toggleItemsExpand() {
      const ta = document.getElementById("genItemsInput");
      const btn = document.getElementById("expandItemsBtn");
      itemsExpanded = !itemsExpanded;
      if (itemsExpanded) {
        ta.classList.add("items-expanded");
        btn.textContent = "Collapse list editor";
      } else {
        ta.classList.remove("items-expanded");
        btn.textContent = "Expand list editor";
      }
    }

    // --------------------------------
    // NAV CLICK HANDLER
    // --------------------------------
    function handleNavClick(event) {
      const target = event.target.closest(".nav-generator");
      if (!target) return;
      const id = target.dataset.id;
      if (!id) return;

      activeGenerator = { id };
      renderGeneratorNav();
      renderActiveGeneratorPanel();
    }

    // --------------------------------
    // INIT
    // --------------------------------
    document.addEventListener("DOMContentLoaded", () => {
      renderGeneratorNav();
      renderActiveGeneratorPanel();

      document.getElementById("generatorNav").addEventListener("click", handleNavClick);
      document.getElementById("addGeneratorBtn").addEventListener("click", openNewGeneratorBox);
      document.getElementById("cancelGeneratorBtn").addEventListener("click", hideGeneratorCreateBox);
      document.getElementById("saveGeneratorBtn").addEventListener("click", handleSaveGenerator);
      document.getElementById("expandItemsBtn").addEventListener("click", toggleItemsExpand);
    });
  </script>
</body>
</html>
